---
export const prerender = false;
import { getCollection, getEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import { SESSION_COOKIE, getUserFromSession } from '../../lib/auth';
import { getRecipeHearts, getUserHearts } from '../../lib/hearts';

const { slug } = Astro.params;
const recipe = await getEntry('recipes', slug as string);

if (!recipe) {
  return Astro.redirect('/404');
}

// Get current user
const sessionId = Astro.cookies.get(SESSION_COOKIE)?.value;
const user = sessionId ? await getUserFromSession(sessionId) : null;

// Get heart data
const globalHearts = await getRecipeHearts();
const heartCount = (globalHearts as any)[recipe.slug] || 0;

const { data } = recipe;
const { Content } = await recipe.render();

// Calculate total time
const totalTime = data.prep_time + data.cook_time;
---

<Layout title={data.title} description={data.description} user={user}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <!-- Back Button -->
    <a href="/recipes" class="inline-flex items-center gap-2 text-sm font-bold uppercase tracking-widest text-gray-400 hover:text-gray-900 transition-colors mb-12">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      All Recipes
    </a>

    <div class="grid lg:grid-cols-2 gap-16 items-start">
      <!-- Left Column: Content -->
      <article>
        <header class="mb-12">
          <div class="flex items-center gap-3 mb-6">
            <span class="px-3 py-1 bg-gray-100 text-[10px] font-bold uppercase tracking-widest text-gray-600 rounded-full">
              {data.category}
            </span>
          </div>
          <h1 class="text-5xl sm:text-7xl font-serif text-gray-900 leading-[1.1] tracking-tight">{data.title}</h1>
        </header>

        <!-- Meta Grid -->
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-16 pb-16 border-b border-gray-100">
           <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span class="text-lg font-light text-gray-700 lowercase">{totalTime} min</span>
          </div>
          <div class="flex items-center gap-2">
            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
            </svg>
            <span class="text-lg font-light text-gray-700 lowercase">{heartCount}</span>
          </div>
        </div>

        <div class="space-y-16">
          <!-- Ingredients -->
          <section>
            <h2 class="text-xs font-bold uppercase tracking-[0.3em] text-gray-400 mb-10 flex items-center gap-6">
              Ingredients
              <div class="h-px bg-gray-100 flex-1"></div>
            </h2>
            <ul class="space-y-6">
              {data.ingredients.map(ingredient => (
                <li class="flex items-baseline gap-4 text-gray-700 font-light border-b border-gray-50 pb-4">
                  <span class="font-serif italic text-gray-400 w-24 flex-shrink-0 text-sm">{ingredient.amount}</span>
                  <span class="text-lg">{ingredient.item}</span>
                </li>
              ))}
            </ul>
          </section>

          <!-- Instructions -->
          <section>
            <h2 class="text-xs font-bold uppercase tracking-[0.3em] text-gray-400 mb-10 flex items-center gap-6">
              Method
              <div class="h-px bg-gray-100 flex-1"></div>
            </h2>
            <div class="space-y-12">
              {data.instructions.map((instruction, index) => (
                <div class="flex gap-8">
                  <span class="text-5xl font-serif text-gray-100 leading-none select-none">{String(index + 1).padStart(2, '0')}</span>
                  <div class="pt-2">
                    <p class="text-xl text-gray-800 font-serif leading-relaxed">
                      {instruction.step}
                    </p>
                  </div>
                </div>
              ))}
            </div>
          </section>

           <!-- Notes -->
           {data.notes && (
            <section class="bg-gray-50 p-12 rounded-sm border-l-4 border-gray-900">
              <h2 class="text-xs font-bold uppercase tracking-[0.3em] text-gray-900 mb-6 font-bold uppercase tracking-[0.3em]">
                Cook's Notes
              </h2>
              <div class="prose prose-serif prose-gray font-light text-lg">
                {data.notes}
              </div>
            </section>
          )}

          <!-- Body Content -->
          <div class="prose prose-serif prose-lg max-w-none 
            prose-headings:font-serif prose-headings:font-bold prose-headings:text-gray-900
            prose-p:text-gray-700 prose-p:leading-relaxed prose-p:font-light
            prose-li:text-gray-700 prose-li:font-light
            prose-strong:text-gray-900 prose-strong:font-bold
            border-t border-gray-100 pt-16 mt-16">
            <Content />
          </div>
        </div>
      </article>

      <!-- Right Column: Image -->
      <aside class="lg:sticky lg:top-24 h-fit">
        {data.featured_image && (
          <div class="group relative aspect-[4/5] overflow-hidden rounded-sm shadow-2xl transition-transform duration-700 hover:scale-[1.01]">
            <img 
              src={data.featured_image} 
              alt={data.title}
              class="w-full h-full object-cover"
            />
            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/5 transition-colors duration-700"></div>
          </div>
        )}
      </aside>
    </div>
  </div>
</Layout>