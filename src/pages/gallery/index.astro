---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { SESSION_COOKIE, getUserFromSession, isUserAdmin, getSiteConfig, isEmailApproved } from '../../lib/auth';
import { getAlbums, type Album } from '../../lib/gallery';

// Check if user is authenticated
let user = null;
let isAdmin = false;
let isApproved = false;
let siteConfig = null;
let albums: Album[] = [];
let error = '';

try {
  const sessionId = Astro.cookies.get(SESSION_COOKIE)?.value;
  user = sessionId ? await getUserFromSession(sessionId) : null;
  isAdmin = sessionId ? await isUserAdmin(sessionId) : false;
  isApproved = user ? await isEmailApproved(user.user_email) : false;

  // If user is authenticated but not approved, send them to request access
  if (user && !isApproved && !isAdmin) {
    return Astro.redirect('/gallery/request-access');
  }

  siteConfig = await getSiteConfig();
  
  // Fetch albums from Supabase
  albums = user && (isApproved || isAdmin) ? await getAlbums() : [];
} catch (e) {
  console.error('Gallery page error:', e);
  error = e instanceof Error ? e.message : 'Unknown error occurred';
}

// Helper to format date from title or created_at
function getDisplayDate(album: any) {
  const dateMatch = album.title.match(/^(\d{2})\/(\d{2})/);
  if (dateMatch) {
    const year = 2000 + parseInt(dateMatch[1]);
    const month = parseInt(dateMatch[2]) - 1;
    return new Date(year, month).toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
  }
  return new Date(album.created_at).toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
}

// Helper to clean title for display
function getDisplayTitle(title: string) {
  return title.replace(/^\d{2}\/\d{2}\s*-\s*/, '').trim();
}
---

<Layout title="Family Gallery" description="Private family photo albums - sign in required">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    {error && (
      <div class="mb-8 p-4 bg-red-50 border border-red-200 text-red-800 rounded-lg">
        <p class="font-bold text-center">‚ö†Ô∏è Database Connection Issue</p>
        <p class="text-sm text-center">Make sure you have added all environment variables (SUPABASE_URL, etc.) in your Netlify dashboard.</p>
        <p class="text-xs mt-2 opacity-50 text-center font-mono">{error}</p>
      </div>
    )}

    {Astro.url.searchParams.has('linked') && (
      <div class="mb-8 p-4 bg-green-50 border border-green-200 text-green-800 rounded-lg text-center animate-pulse">
        ‚úÖ Google Photos successfully linked!
      </div>
    )}

    <!-- Page Header -->
    <div class="text-center mb-12 text-gray-900 dark:text-gray-100">
      <h1 class="text-4xl font-bold mb-4">Family Gallery</h1>
      <p class="text-xl text-gray-600 dark:text-gray-400 max-w-2xl mx-auto">
        Our private collection of family photos and memories, organized in beautiful albums.
        {user ? `Welcome back, ${user.user_email}!` : 'Sign in with your Google account to view our shared moments.'}
      </p>
    </div>

    {!user ? (
      <!-- ... existing sign in section ... -->
      <!-- Sign In Section -->
      <div class="text-center py-16">
        <div class="w-32 h-32 bg-primary-100 rounded-full flex items-center justify-center mx-auto mb-6">
          <svg class="w-16 h-16 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
          </svg>
        </div>
        <h2 class="text-3xl font-semibold text-gray-900 mb-4">Sign In Required</h2>
        <p class="text-lg text-gray-600 mb-8 max-w-xl mx-auto">
          This gallery is private and requires authentication. Sign in with your Google account to access family photos.
        </p>
        
        <a 
          href="/auth/login" 
          class="inline-flex items-center gap-3 px-8 py-4 bg-white border-2 border-gray-300 rounded-lg hover:bg-gray-50 hover:border-gray-400 transition-colors text-gray-800 font-medium text-lg shadow-sm"
        >
          <svg class="w-6 h-6" viewBox="0 0 24 24">
            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
          </svg>
          Sign in with Google
        </a>
        
        <p class="mt-6 text-sm text-gray-500">
          Don't have access? <a href="/gallery/request-access" class="text-primary-600 hover:text-primary-700 font-medium">Request access</a>
        </p>
      </div>
    ) : (
      <!-- Gallery Content --> 
      <div class="space-y-12">
        {isAdmin && (
          <div class="bg-amber-50 border-2 border-amber-200 rounded-xl p-6 shadow-sm">
            <h2 class="text-xl font-bold text-amber-900 mb-4 flex items-center gap-2">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Admin: Add Album via Share Link
            </h2>
            <div class="flex flex-col gap-4">
              <p class="text-amber-800 text-sm">
                Paste a <strong>Google Photos Share Link</strong> below to instantly sync an album.
                <br /><span class="opacity-75">Matches naming pattern "YY/MM - Title" automatically.</span>
              </p>
              
              <div class="flex flex-col sm:flex-row gap-3">
                <input 
                  type="url" 
                  id="sync-url" 
                  placeholder="https://photos.app.goo.gl/..." 
                  class="flex-1 px-4 py-2 border-2 border-amber-200 rounded-lg focus:outline-none focus:border-amber-400 dark:bg-amber-900/10"
                />
                <button 
                  id="sync-btn"
                  class="px-6 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg transition-all font-bold shadow-md disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                >
                  <span id="btn-text">Sync Album</span>
                  <div id="btn-spinner" class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                </button>
              </div>
              <div id="sync-status" class="hidden text-sm font-medium"></div>
            </div>
          </div>
        )}

        <script is:inline>
          // Use is:inline to ensure the script runs immediately
          const initSyncForm = () => {
              const syncBtn = document.getElementById('sync-btn');
              const syncUrl = document.getElementById('sync-url');
              const syncStatus = document.getElementById('sync-status');
              const btnText = document.getElementById('btn-text');
              const btnSpinner = document.getElementById('btn-spinner');

              if (!syncBtn || !syncUrl) return;

              syncBtn.onclick = async (e) => {
                e.preventDefault();
                const url = syncUrl.value.trim();
                if (!url) {
                  alert('Please paste a Google Photos link first.');
                  return;
                }

                console.log('Starting sync for:', url);

                // Show loading state
                if (syncStatus) {
                  syncStatus.classList.remove('hidden', 'text-green-600', 'text-red-600');
                  syncStatus.classList.add('text-amber-600', 'block');
                  syncStatus.textContent = '‚è≥ Processing album... this may take 10-20 seconds.';
                }
                syncBtn.disabled = true;
                if (btnText) btnText.textContent = 'Syncing...';
                if (btnSpinner) btnSpinner.classList.remove('hidden');

                try {
                  const res = await fetch('/api/gallery/sync-link', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ url })
                  });

                  const data = await res.json();
                  console.log('Sync response:', data);

                  if (data.success) {
                    if (syncStatus) {
                      syncStatus.classList.remove('text-amber-600');
                      syncStatus.classList.add('text-green-600');
                      syncStatus.textContent = `‚úÖ Success! Synced "${data.title}" with ${data.count} photos. Refreshing gallery...`;
                    }
                    setTimeout(() => window.location.reload(), 2000);
                  } else {
                    throw new Error(data.error || 'Failed to sync album');
                  }
                } catch (err) {
                  console.error('Sync error:', err);
                  if (syncStatus) {
                    syncStatus.classList.remove('text-amber-600');
                    syncStatus.classList.add('text-red-600');
                    syncStatus.textContent = `‚ùå Error: ${err.message}`;
                  }
                  syncBtn.disabled = false;
                  if (btnText) btnText.textContent = 'Sync Album';
                  if (btnSpinner) btnSpinner.classList.add('hidden');
                }
              };
            };

            // Run on load and after any Astro view transitions
            initSyncForm();
            document.addEventListener('astro:after-swap', initSyncForm);
          </script>


        {albums.length > 0 ? (
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
            {albums.map((album) => (
              <a 
                href={`/gallery/${album.google_album_id}`}
                class="group bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300 border border-gray-100 flex flex-col"
              >
                <div class="aspect-[4/3] overflow-hidden relative">
                  <img 
                    src={`${album.cover_image_url}=w800-h600-c`} 
                    alt={album.title}
                    class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"
                    loading="lazy"
                  />
                  <div class="absolute inset-0 bg-black/20 group-hover:bg-black/0 transition-colors duration-300" />
                  <div class="absolute top-4 right-4 bg-white/90 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-bold text-gray-800 shadow-sm">
                    {album.photo_count} photos
                  </div>
                </div>
                <div class="p-6">
                  <h3 class="text-xl font-bold text-gray-900 group-hover:text-primary-600 transition-colors">
                    {getDisplayTitle(album.title)}
                  </h3>
                  <p class="text-sm text-gray-500 mt-2 flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    {getDisplayDate(album)}
                  </p>
                </div>
              </a>
            ))}
          </div>
        ) : (
          <div class="text-center py-16 bg-gray-50 rounded-3xl border-2 border-dashed border-gray-200">
            <div class="w-24 h-24 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
              <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
            </div>
            <h2 class="text-2xl font-semibold text-gray-900 mb-2">No Albums Found</h2>
            <p class="text-gray-600 max-w-sm mx-auto mb-8">
              {isAdmin 
                ? "You haven't synced any albums yet. Make sure you've joined an album starting with 'YY/MM - ' and wait for the scanner to run."
                : "The gallery is being set up. Check back soon for family memories!"}
            </p>
          </div>
        )}
        
        <!-- Sign Out Button -->
        <div class="flex justify-center mt-12">
          <a 
            href="/auth/logout" 
            class="inline-flex items-center gap-2 px-6 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors text-gray-700 font-medium"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
            Sign Out
          </a>
        </div>
      </div>
    )}
    
    <!-- Features Preview (shown to all) -->
    <div class="mt-16">
      <h3 class="text-2xl font-semibold text-center text-gray-900 mb-8">Gallery Features</h3>
      <div class="grid md:grid-cols-3 gap-6 max-w-3xl mx-auto mb-8">
        <div class="bg-white p-6 rounded-lg shadow-sm border">
          <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mx-auto mb-4">
            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
          </div>
          <h3 class="font-semibold text-gray-900 mb-2">Secure Access</h3>
          <p class="text-sm text-gray-600">Google authentication with family-only access control</p>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow-sm border">
          <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mx-auto mb-4">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
            </svg>
          </div>
          <h3 class="font-semibold text-gray-900 mb-2">Album Feed</h3>
          <p class="text-sm text-gray-600">Instagram-style browsing with newest albums first</p>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow-sm border">
          <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mx-auto mb-4">
            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2h4a1 1 0 011 1v1a1 1 0 01-1 1v9a2 2 0 01-2 2H5a2 2 0 01-2-2V7a1 1 0 01-1-1V5a1 1 0 011-1h4zM9 3v1h6V3H9z" />
            </svg>
          </div>
          <h3 class="font-semibold text-gray-900 mb-2">Google Photos</h3>
          <p class="text-sm text-gray-600">Seamless sync with your Google Photos albums</p>
        </div>
      </div>
      
      <!-- Development Status -->
      <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 max-w-lg mx-auto mt-8">
        <h3 class="font-semibold text-blue-900 mb-2">Development Status</h3>
        <ul class="text-sm text-blue-800 space-y-1 text-left">
          <li>‚úÖ Basic site structure and recipes</li>
          <li>‚úÖ Google OAuth authentication setup</li>
          <li>üîÑ Google Photos API integration</li>
          <li>üîÑ Instagram-style gallery interface</li>
          <li>‚è≥ Photo browsing and comments</li>
        </ul>
      </div>
    </div>
  </div>
</Layout>