---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { SESSION_COOKIE, getApprovedUser, getUserFromSession, getSiteConfig } from '../../lib/auth';
import { getAlbums, type Album } from '../../lib/gallery';
import { supabaseAdmin } from '../../lib/supabase';

// Check if user is authenticated
let user = null;
let isAdmin = false;
let isApproved = false;
let siteConfig = null;
let albums: Album[] = [];
let error = '';
let accessRequestStatus: 'pending' | 'denied' | null = null;
let needsApproval = false;

Astro.response.headers.set('Cache-Control', 'private, max-age=60, stale-while-revalidate=300');

try {
  const sessionId = Astro.cookies.get(SESSION_COOKIE)?.value;
  user = sessionId ? await getUserFromSession(sessionId) : null;
  const approvedUser = user ? await getApprovedUser(user.user_email) : null;
  isApproved = !!approvedUser;
  isAdmin = approvedUser?.role === 'admin';
  needsApproval = !!user && !isApproved && !isAdmin;

  // If user is authenticated but not approved, send them to request access
  if (needsApproval) {
    const { data: accessRequest } = await supabaseAdmin
      .from('access_requests')
      .select('status')
      .eq('email', user.user_email)
      .order('requested_at', { ascending: false })
      .limit(1)
      .maybeSingle();

    accessRequestStatus = accessRequest?.status ?? null;

    if (!accessRequestStatus || accessRequestStatus === 'denied') {
      return Astro.redirect('/gallery/request-access');
    }
  }

  siteConfig = await getSiteConfig();
  
  // Fetch albums from Supabase
  albums = user && (isApproved || isAdmin) ? await getAlbums() : [];
} catch (e) {
  console.error('Gallery page error:', e);
  error = e instanceof Error ? e.message : 'Unknown error occurred';
}

// Helper to format date from title or created_at
function getDisplayDate(album: any) {
  const dateMatch = album.title.match(/^(\d{2})\/(\d{2})/);
  if (dateMatch) {
    const year = 2000 + parseInt(dateMatch[1]);
    const month = parseInt(dateMatch[2]) - 1;
    return new Date(year, month).toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
  }
  return new Date(album.created_at).toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
}

// Helper to clean title for display
function getDisplayTitle(title: string) {
  return title.replace(/^\d{2}\/\d{2}\s*-\s*/, '').trim();
}

function getAlbumDate(album: any) {
  const title = album?.title || '';
  const match = title.match(/^(\d{2,4})\/(\d{2})(?:\/(\d{2}))?/);
  if (match) {
    let year = parseInt(match[1], 10);
    if (year < 100) year += 2000;
    const month = parseInt(match[2], 10) - 1;
    const day = match[3] ? parseInt(match[3], 10) : 1;
    const parsed = new Date(year, month, day);
    if (!Number.isNaN(parsed.getTime())) {
      return parsed;
    }
  }

  const created = new Date(album.created_at);
  return Number.isNaN(created.getTime()) ? new Date() : created;
}

const albumsWithDates = albums
  .map((album) => {
    const date = getAlbumDate(album);
    return {
      album,
      date,
      year: date.getFullYear(),
      dayLabel: date.toLocaleDateString('en-GB', { month: 'long' })
    };
  })
  .sort((a, b) => b.date.getTime() - a.date.getTime());

const albumsByYear = albumsWithDates.reduce((acc, item) => {
  const key = String(item.year);
  if (!acc[key]) acc[key] = [];
  acc[key].push(item);
  return acc;
}, {} as Record<string, typeof albumsWithDates>);
---

<Layout title="Family Gallery" description="Private family photo albums - sign in required" user={user} isAdmin={isAdmin} enableTransitions={false}>
  <div class={`max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 ${!user ? 'h-[calc(100vh-80px)] flex flex-col justify-center' : 'pt-6 pb-16'}`}>
    {error && (
      <div class="mb-12 p-6 bg-red-50 border border-red-100 text-red-800 rounded-2xl">
        <p class="font-serif text-xl mb-2">Something went wrong</p>
        <p class="text-sm opacity-80">{error}</p>
      </div>
    )}

    {!user ? (
      <!-- Sign In Section -->
      <div class="text-center">
        <div class="max-w-md mx-auto">
          <h2 class="text-3xl font-serif mb-6">Access Required</h2>
          <p class="text-gray-500 mb-10 leading-relaxed">
            To protect our family's privacy, this gallery is only accessible to approved members.
          </p>
          
          <a 
            href={`/auth/login?next=${Astro.url.pathname}`} 
            class="inline-flex items-center gap-3 px-10 py-4 bg-gray-900 text-white rounded-full hover:bg-gray-800 transition-all text-sm font-bold tracking-widest uppercase shadow-xl hover:shadow-2xl hover:-translate-y-1"
          >
            <svg class="w-5 h-5" viewBox="0 0 24 24">
              <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" opacity="0.8"/>
            </svg>
            Sign in with Google
          </a>
          
          <p class="mt-8 text-sm text-gray-400">
            Don't have access? <a href="/gallery/request-access" class="text-gray-900 font-bold border-b border-gray-900">Request access</a>
          </p>
        </div>
      </div>
    ) : accessRequestStatus === 'pending' ? (
      <!-- Pending Approval Section -->
      <div class="text-center">
        <div class="max-w-md mx-auto">
          <h2 class="text-3xl font-serif mb-6">Request Received</h2>
          <p class="text-gray-500 mb-6 leading-relaxed">
            Thanks for your request. Please wait to hear from us once it's been reviewed.
          </p>
          <p class="text-xs font-bold uppercase tracking-widest text-gray-400">
            We'll email you when your status changes.
          </p>
        </div>
      </div>
    ) : needsApproval ? (
      <!-- Request Access Fallback -->
      <div class="text-center">
        <div class="max-w-md mx-auto">
          <h2 class="text-3xl font-serif mb-6">Request Access</h2>
          <p class="text-gray-500 mb-8 leading-relaxed">
            This gallery is private. Ask for access and we will review your request.
          </p>
          <a 
            href="/gallery/request-access"
            class="inline-flex items-center gap-3 px-10 py-4 bg-gray-900 text-white rounded-full hover:bg-gray-800 transition-all text-sm font-bold tracking-widest uppercase shadow-xl hover:shadow-2xl hover:-translate-y-1"
          >
            Request access
          </a>
        </div>
      </div>
    ) : (
      <!-- Gallery Content --> 
      <div class="space-y-6">
        {/* Search + View Toggle */}
        <div class="space-y-4">
          <div class="flex flex-wrap items-center gap-2" data-filter-group>
            {['Albums', 'Itinerary'].map(view => (
              <button
                type="button"
                class="filter-btn px-4 py-1.5 rounded-full border border-gray-100 bg-white text-[10px] font-bold uppercase tracking-widest text-gray-400 transition-all duration-100 select-none data-[active=true]:bg-gray-100/50 data-[active=true]:text-gray-900 data-[active=true]:border-gray-400 [&:not([data-active=true])]:hover:text-gray-900 [&:not([data-active=true])]:hover:border-gray-200"
                data-filter="gallery-view"
                data-value={view.toLowerCase()}
                data-active={view === 'Albums' ? 'true' : 'false'}
              >
                {view}
              </button>
            ))}
          </div>
          <div class="w-full" id="gallery-search-wrap">
            <div class="relative">
              <input 
                type="text" 
                id="gallery-search" 
                placeholder="Search albums..." 
                class="w-full px-5 py-2.5 bg-gray-50/50 border border-gray-200 rounded-xl focus:outline-none focus:border-gray-500 transition-colors duration-[250ms] font-light text-base"
              />
              <div class="absolute right-5 top-1/2 -translate-y-1/2 text-gray-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>
              </div>
            </div>
          </div>
        </div>

        <div id="albums-view">
          {albums.length > 0 ? (
            <div id="gallery-grid" class="grid grid-cols-2 md:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-6">
              {albums.map((album) => (
                <a 
                  href={`/gallery/${album.google_album_id}`}
                  class="group flex flex-col gallery-item"
                  data-title={album.title.toLowerCase()}
                >
                  <div class="aspect-square overflow-hidden bg-gray-100 rounded-lg relative shadow-sm group-hover:shadow-2xl transition-all duration-700 ease-out">
                    <img 
                      src={`/api/gallery/image?url=${encodeURIComponent(album.cover_image_url)}&w=1000`} 
                      alt={album.title}
                      class="w-full h-full object-cover transition-transform duration-[2s] ease-out group-hover:scale-110"
                      loading="lazy"
                    />
                    <div class="absolute inset-0 bg-black/5 group-hover:bg-black/20 transition-colors duration-500" />
                    
                    <!-- Photo Count Badge -->
                    <div class="absolute bottom-6 right-6 px-3 py-1 bg-white/10 backdrop-blur-md border border-white/20 rounded-full text-[10px] uppercase tracking-[0.2em] font-bold text-white transition-opacity duration-500">
                      {album.photo_count} Photos
                    </div>
                  </div>
                  
                  <div class="mt-6">
                    <div class="flex items-start justify-between gap-4">
                      <div>
                        <h3 class="text-lg md:text-xl font-serif text-gray-900 group-hover:text-primary-600 transition-colors duration-300">
                          {getDisplayTitle(album.title)}
                        </h3>
                        <p class="text-xs uppercase tracking-[0.2em] text-gray-400 mt-2 font-bold">
                          {getDisplayDate(album)}
                        </p>
                      </div>
                      <div class="pt-1 opacity-0 group-hover:opacity-100 -translate-x-4 group-hover:translate-x-0 transition-all duration-500">
                        <svg class="w-6 h-6 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                        </svg>
                      </div>
                    </div>
                  </div>
                </a>
              ))}
            </div>
            <div id="no-results" class="hidden py-32 text-center">
               <h2 class="text-2xl font-serif text-gray-400">No albums match your search.</h2>
            </div>
          ) : (
            <div class="py-32 text-center border-t border-gray-100">
               <h2 class="text-2xl font-serif text-gray-400">No albums have been added yet.</h2>
               {isAdmin && <p class="text-sm text-gray-400 mt-4 uppercase tracking-widest font-bold">Visit the Admin panel to sync your first album.</p>}
            </div>
          )}
        </div>
        <div id="itinerary-view" class="hidden">
          {albumsWithDates.length > 0 ? (
            <div class="space-y-10">
              {Object.entries(albumsByYear)
                .sort(([yearA], [yearB]) => Number(yearB) - Number(yearA))
                .map(([year, items]) => (
                <div class="rounded-3xl border border-gray-100 bg-white/70 p-6 md:p-8 shadow-sm">
                  <div class="flex items-center gap-4 mb-6">
                    <h2 class="text-3xl font-serif text-gray-900">{year}</h2>
                    <span class="text-xs font-bold uppercase tracking-widest text-gray-400">
                      {items.length} galleries
                    </span>
                  </div>

                  <div class="relative">
                    <div class="absolute left-[112px] top-1 bottom-1 w-px bg-gradient-to-b from-sky-200 via-gray-200 to-gray-200"></div>
                    <div class="space-y-1">
                      {items.map(({ album, dayLabel }) => (
                        <a
                          href={`/gallery/${album.google_album_id}?from=itinerary`}
                          data-itinerary-link
                          class="group relative grid grid-cols-[72px_24px_1fr] items-center gap-4 px-3 py-2 rounded-2xl transition-all hover:bg-sky-50/70 hover:shadow-sm"
                        >
                          <span class="text-sm font-medium text-gray-500 tabular-nums">{dayLabel}</span>
                          <span class="relative flex items-center justify-center">
                            <span class="w-3 h-3 rounded-full border border-sky-300 bg-white shadow-[0_0_0_4px_rgba(56,189,248,0.12)] group-hover:border-sky-600 group-hover:bg-sky-600 transition-colors"></span>
                          </span>
                          <span class="text-base font-semibold text-gray-900 group-hover:text-sky-700 transition-colors">
                            {getDisplayTitle(album.title)}
                          </span>
                        </a>
                      ))}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div class="py-24 text-center border-t border-gray-100">
              <h2 class="text-2xl font-serif text-gray-400">No itineraries yet.</h2>
            </div>
          )}
        </div>
      </div>
    )}
  </div>

  <script is:inline>
    function initGallerySearch() {
      const searchInput = document.getElementById('gallery-search');
      const searchWrap = document.getElementById('gallery-search-wrap');
      const galleryItems = document.querySelectorAll('.gallery-item');
      const galleryGrid = document.getElementById('gallery-grid');
      const noResults = document.getElementById('no-results');
      const albumsView = document.getElementById('albums-view');
      const itineraryView = document.getElementById('itinerary-view');
      const filterGroup = document.querySelector('[data-filter-group]');
      const filterBtns = document.querySelectorAll('[data-filter="gallery-view"]');
      const itineraryLinks = document.querySelectorAll('[data-itinerary-link]');

      if (!searchInput) return;

      const normalize = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

      searchInput.addEventListener('input', (e) => {
        const query = normalize(e.target.value.trim());
        let hasResults = false;

        galleryItems.forEach(item => {
          const title = normalize(item.getAttribute('data-title') || '');
          if (title.includes(query)) {
            item.classList.remove('hidden');
            hasResults = true;
          } else {
            item.classList.add('hidden');
          }
        });

        if (hasResults) {
          noResults.classList.add('hidden');
          if (galleryGrid) galleryGrid.classList.remove('hidden');
        } else {
          noResults.classList.remove('hidden');
          if (galleryGrid) galleryGrid.classList.add('hidden');
        }
      });

      function setActiveView(view, options = {}) {
        filterBtns.forEach((btn) => {
          btn.setAttribute('data-active', btn.getAttribute('data-value') === view ? 'true' : 'false');
        });

        const isAlbums = view === 'albums';
        if (albumsView) albumsView.classList.toggle('hidden', !isAlbums);
        if (itineraryView) itineraryView.classList.toggle('hidden', isAlbums);
        if (searchWrap) searchWrap.classList.toggle('hidden', !isAlbums);

        sessionStorage.setItem('galleryView', view);
        if (!options.skipUrl) {
          const url = new URL(window.location.href);
          if (view === 'albums') {
            url.searchParams.delete('view');
          } else {
            url.searchParams.set('view', view);
          }
          history.replaceState({}, '', url);
        }
      }

      filterGroup?.addEventListener('click', (event) => {
        const rawTarget = event.target;
        const element = rawTarget instanceof Element ? rawTarget : rawTarget?.parentElement;
        const btn = element?.closest ? element.closest('button') : null;
        if (!btn) return;

        const view = btn.getAttribute('data-value');
        if (!view) return;
        setActiveView(view);
      });

      itineraryLinks.forEach((link) => {
        if (link._hasHandler) return;
        link.addEventListener('click', () => {
          sessionStorage.setItem('galleryView', 'itinerary');
          sessionStorage.setItem('galleryScroll', String(window.scrollY));
        });
        link._hasHandler = true;
      });

      const params = new URLSearchParams(window.location.search);
      const requestedView = params.get('view');
      const storedView = sessionStorage.getItem('galleryView');
      const initialView = requestedView || storedView || 'albums';
      setActiveView(initialView, { skipUrl: !!requestedView });

      if (initialView === 'itinerary') {
        const storedScroll = sessionStorage.getItem('galleryScroll');
        if (storedScroll) {
          const scrollY = Number(storedScroll);
          if (!Number.isNaN(scrollY)) {
            requestAnimationFrame(() => window.scrollTo(0, scrollY));
          }
        }
      }
    }

    // Initialize on load
    initGallerySearch();
    
    // Re-initialize after view transitions
    document.addEventListener('astro:after-swap', initGallerySearch);
  </script>
</Layout>

{!user && (
  <style is:global>
    html, body {
      overflow: hidden !important;
      height: 100%;
    }
  </style>
)}