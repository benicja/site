---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { SESSION_COOKIE, getUserFromSession, isUserAdmin, getSiteConfig, isEmailApproved } from '../../lib/auth';
import { getAlbums, type Album } from '../../lib/gallery';

// Check if user is authenticated
let user = null;
let isAdmin = false;
let isApproved = false;
let siteConfig = null;
let albums: Album[] = [];
let error = '';

try {
  const sessionId = Astro.cookies.get(SESSION_COOKIE)?.value;
  user = sessionId ? await getUserFromSession(sessionId) : null;
  isAdmin = sessionId ? await isUserAdmin(sessionId) : false;
  isApproved = user ? await isEmailApproved(user.user_email) : false;

  // If user is authenticated but not approved, send them to request access
  if (user && !isApproved && !isAdmin) {
    return Astro.redirect('/gallery/request-access');
  }

  siteConfig = await getSiteConfig();
  
  // Fetch albums from Supabase
  albums = user && (isApproved || isAdmin) ? await getAlbums() : [];
} catch (e) {
  console.error('Gallery page error:', e);
  error = e instanceof Error ? e.message : 'Unknown error occurred';
}

// Helper to format date from title or created_at
function getDisplayDate(album: any) {
  const dateMatch = album.title.match(/^(\d{2})\/(\d{2})/);
  if (dateMatch) {
    const year = 2000 + parseInt(dateMatch[1]);
    const month = parseInt(dateMatch[2]) - 1;
    return new Date(year, month).toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
  }
  return new Date(album.created_at).toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
}

// Helper to clean title for display
function getDisplayTitle(title: string) {
  return title.replace(/^\d{2}\/\d{2}\s*-\s*/, '').trim();
}
---

<Layout title="Family Gallery" description="Private family photo albums - sign in required">
  <div class={`max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 ${!user ? 'h-[calc(100vh-80px)] flex flex-col justify-center' : 'pt-6 pb-16'}`}>
    {error && (
      <div class="mb-12 p-6 bg-red-50 border border-red-100 text-red-800 rounded-2xl">
        <p class="font-serif text-xl mb-2">Something went wrong</p>
        <p class="text-sm opacity-80">{error}</p>
      </div>
    )}

    {!user ? (
      <!-- Sign In Section -->
      <div class="text-center">
        <div class="max-w-md mx-auto">
          <h2 class="text-3xl font-serif mb-6">Access Required</h2>
          <p class="text-gray-500 mb-10 leading-relaxed">
            To protect our family's privacy, this gallery is only accessible to approved members.
          </p>
          
          <a 
            href={`/auth/login?next=${Astro.url.pathname}`} 
            class="inline-flex items-center gap-3 px-10 py-4 bg-gray-900 text-white rounded-full hover:bg-gray-800 transition-all text-sm font-bold tracking-widest uppercase shadow-xl hover:shadow-2xl hover:-translate-y-1"
          >
            <svg class="w-5 h-5" viewBox="0 0 24 24">
              <path fill="currentColor" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
              <path fill="currentColor" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" opacity="0.8"/>
            </svg>
            Sign in with Google
          </a>
          
          <p class="mt-8 text-sm text-gray-400">
            Don't have access? <a href="/gallery/request-access" class="text-gray-900 font-bold border-b border-gray-900">Request access</a>
          </p>
        </div>
      </div>
    ) : (
      <!-- Gallery Content --> 
      <div class="space-y-6">
        {/* Search Bar */}
        <div class="w-full">
          <div class="relative">
            <input 
              type="text" 
              id="gallery-search" 
              placeholder="Search gallery..." 
              class="w-full px-5 py-2.5 bg-gray-50/50 border border-gray-200 rounded-xl focus:outline-none focus:border-gray-500 transition-colors duration-[250ms] font-light text-base"
            />
            <div class="absolute right-5 top-1/2 -translate-y-1/2 text-gray-400">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
          </div>
        </div>

        {albums.length > 0 ? (
          <div id="gallery-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-6">
            {albums.map((album) => (
              <a 
                href={`/gallery/${album.google_album_id}`}
                class="group flex flex-col gallery-item"
                data-title={album.title.toLowerCase()}
              >
                <div class="aspect-square overflow-hidden bg-gray-100 rounded-lg relative shadow-sm group-hover:shadow-2xl transition-all duration-700 ease-out">
                  <img 
                    src={`${album.cover_image_url}=w1000-h1250-c`} 
                    alt={album.title}
                    class="w-full h-full object-cover transition-transform duration-[2s] ease-out group-hover:scale-110"
                    loading="lazy"
                  />
                  <div class="absolute inset-0 bg-black/5 group-hover:bg-black/20 transition-colors duration-500" />
                  
                  <!-- Photo Count Badge -->
                  <div class="absolute bottom-6 right-6 px-3 py-1 bg-white/10 backdrop-blur-md border border-white/20 rounded-full text-[10px] uppercase tracking-[0.2em] font-bold text-white transition-opacity duration-500">
                    {album.photo_count} Photos
                  </div>
                </div>
                
                <div class="mt-6">
                  <div class="flex items-start justify-between gap-4">
                    <div>
                      <h3 class="text-xl font-serif text-gray-900 group-hover:text-primary-600 transition-colors duration-300">
                        {getDisplayTitle(album.title)}
                      </h3>
                      <p class="text-xs uppercase tracking-[0.2em] text-gray-400 mt-2 font-bold">
                        {getDisplayDate(album)}
                      </p>
                    </div>
                    <div class="pt-1 opacity-0 group-hover:opacity-100 -translate-x-4 group-hover:translate-x-0 transition-all duration-500">
                      <svg class="w-6 h-6 text-gray-900" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                      </svg>
                    </div>
                  </div>
                </div>
              </a>
            ))}
          </div>
          <div id="no-results" class="hidden py-32 text-center">
             <h2 class="text-2xl font-serif text-gray-400">No albums match your search.</h2>
          </div>
        ) : (
          <div class="py-32 text-center border-t border-gray-100">
             <h2 class="text-2xl font-serif text-gray-400">No albums have been added yet.</h2>
             {isAdmin && <p class="text-sm text-gray-400 mt-4 uppercase tracking-widest font-bold">Visit the Admin panel to sync your first album.</p>}
          </div>
        )}
      </div>
    )}
  </div>

  <script is:inline>
    function initGallerySearch() {
      const searchInput = document.getElementById('gallery-search');
      const galleryItems = document.querySelectorAll('.gallery-item');
      const galleryGrid = document.getElementById('gallery-grid');
      const noResults = document.getElementById('no-results');

      if (!searchInput) return;

      const normalize = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

      searchInput.addEventListener('input', (e) => {
        const query = normalize(e.target.value.trim());
        let hasResults = false;

        galleryItems.forEach(item => {
          const title = normalize(item.getAttribute('data-title') || '');
          if (title.includes(query)) {
            item.classList.remove('hidden');
            hasResults = true;
          } else {
            item.classList.add('hidden');
          }
        });

        if (hasResults) {
          noResults.classList.add('hidden');
          if (galleryGrid) galleryGrid.classList.remove('hidden');
        } else {
          noResults.classList.remove('hidden');
          if (galleryGrid) galleryGrid.classList.add('hidden');
        }
      });
    }

    // Initialize on load
    initGallerySearch();
    
    // Re-initialize after view transitions
    document.addEventListener('astro:after-swap', initGallerySearch);
  </script>
</Layout>

{!user && (
  <style is:global>
    html, body {
      overflow: hidden !important;
      height: 100%;
    }
  </style>
)}